//@version=5
indicator("All-in-One Toolkit", overlay=true, max_labels_count=500, max_lines_count=500)

// === Symbol & timeframe configuration ===

use_alt_symbol = input.bool(false, "Use alternative symbol")
alt_symbol     = input.symbol("BINANCE:BTCUSDT", "Alternative symbol")
alt_tf         = input.timeframe("", "Alternative timeframe")
source_input   = input.source(close, "Source" )

calc_symbol = use_alt_symbol ? alt_symbol : syminfo.tickerid
calc_tf     = alt_tf == "" ? timeframe.period : alt_tf

request_src(symbol, timeframe, expression) =>
    request.security(symbol, timeframe, expression)

price = request_src(calc_symbol, calc_tf, source_input)

// === Moving average suite ===

enable_ma1   = input.bool(true, "Show MA #1")
ma1_length   = input.int(20, "MA #1 length", minval=1)
ma1_type     = input.string("EMA", "MA #1 type", options=["SMA", "EMA", "WMA", "HMA", "RMA"])
ma1_color    = input.color(color.orange, "MA #1 color")

enable_ma2   = input.bool(true, "Show MA #2")
ma2_length   = input.int(50, "MA #2 length", minval=1)
ma2_type     = input.string("SMA", "MA #2 type", options=["SMA", "EMA", "WMA", "HMA", "RMA"])
ma2_color    = input.color(color.teal, "MA #2 color")

ma_calc(length, ma_type, src) =>
    switch ma_type
        "EMA" => ta.ema(src, length)
        "WMA" => ta.wma(src, length)
        "HMA" => ta.hma(src, length)
        "RMA" => ta.rma(src, length)
        => ta.sma(src, length)

ma1 = enable_ma1 ? ma_calc(ma1_length, ma1_type, price) : na
ma2 = enable_ma2 ? ma_calc(ma2_length, ma2_type, price) : na

plot(ma1, "MA #1", ma1_color, 2)
plot(ma2, "MA #2", ma2_color, 2)

// === Trend ribbons ===

ribbon_enable       = input.bool(true, "Show trend ribbon")
ribbon_fast_length  = input.int(8, "Ribbon fast length", minval=1)
ribbon_slow_length  = input.int(21, "Ribbon slow length", minval=1)
ribbon_slope_period = input.int(5, "Ribbon slope period", minval=1)

ribbon_fast = ta.ema(price, ribbon_fast_length)
ribbon_slow = ta.ema(price, ribbon_slow_length)
ribbon_diff = ribbon_fast - ribbon_slow
ribbon_slope = ta.ema(ribbon_diff, ribbon_slope_period)

ribbon_color = ribbon_slope > 0 ? color.new(color.green, 50) : color.new(color.red, 50)

plot(ribbon_enable ? ribbon_fast : na, "Ribbon fast", color.new(color.white, 80))
plot(ribbon_enable ? ribbon_slow : na, "Ribbon slow", color.new(color.gray, 80))
plot(ribbon_enable ? ribbon_slope + ribbon_slow : na, "Ribbon slope offset", ribbon_color, style=plot.style_area, transp=65)

// === RSI & Stochastic ===

show_rsi          = input.bool(true, "Show RSI pane", inline="RSI")
rsi_length        = input.int(14, "Length", inline="RSI", minval=1)
rsi_ob            = input.int(70, "Overbought", inline="RSI", minval=50, maxval=100)
rsi_os            = input.int(30, "Oversold", inline="RSI", minval=0, maxval=50)

show_stoch        = input.bool(true, "Show Stochastic pane", inline="STO")
stoch_k_length    = input.int(14, "K length", inline="STO", minval=1)
stoch_k_smooth    = input.int(3, "K smoothing", inline="STO", minval=1)
stoch_d_length    = input.int(3, "D length", inline="STO", minval=1)
stoch_ob          = input.int(80, "Overbought", inline="STO", minval=50, maxval=100)
stoch_os          = input.int(20, "Oversold", inline="STO", minval=0, maxval=50)

rsi_val = ta.rsi(price, rsi_length)
plot(show_rsi ? rsi_val : na, "RSI", color.new(color.blue, 0), 2, display=display.none)
hline(show_rsi ? rsi_ob : na, "RSI OB", color.new(color.red, 50), display=display.none)
hline(show_rsi ? rsi_os : na, "RSI OS", color.new(color.green, 50), display=display.none)

k = ta.sma(ta.stoch(close, high, low, stoch_k_length), stoch_k_smooth)
d = ta.sma(k, stoch_d_length)
plot(show_stoch ? k : na, "Stoch %K", color.new(color.orange, 0), 2, display=display.none)
plot(show_stoch ? d : na, "Stoch %D", color.new(color.purple, 0), 2, display=display.none)
hline(show_stoch ? stoch_ob : na, "Stoch OB", color.new(color.red, 50), display=display.none)
hline(show_stoch ? stoch_os : na, "Stoch OS", color.new(color.green, 50), display=display.none)

// === Volume profile snapshot ===

vp_show        = input.bool(false, "Show volume profile")
vp_rows        = input.int(24, "Profile rows", minval=2, maxval=200)
vp_lookback    = input.int(100, "Lookback bars", minval=1)
vp_color       = input.color(color.new(color.gray, 60), "Profile color")

var vp_line_array = array.new_line()

if barstate.isnew
    for l in vp_line_array
        line.delete(l)
    array.clear(vp_line_array)

if vp_show
    start_index = bar_index - math.min(bar_index, vp_lookback)
    highest_price = ta.highest(high, vp_lookback)
    lowest_price  = ta.lowest(low, vp_lookback)
    step = (highest_price - lowest_price) / vp_rows
    if step > 0
        for idx = 0 to vp_rows - 1
            price_level = lowest_price + idx * step
            volume_at_level = 0.0
            for i = 0 to vp_lookback - 1
                in_range = bar_index - i >= start_index
                if in_range and low[i] <= price_level and high[i] >= price_level
                    weight = (close[i] - price_level) / step
                    volume_at_level += volume[i] * (1 - math.abs(weight))
            line_start = bar_index - vp_lookback
            line_end = bar_index
            line_y = price_level
            line_obj = line.new(line_start, line_y, line_end, line_y, extend=extend.none, color=vp_color, width=1)
            array.push(vp_line_array, line_obj)

// === Alert conditions ===

bullish_cross = ta.crossover(ma1, ma2)
bearish_cross = ta.crossunder(ma1, ma2)

alertcondition(enable_ma1 and enable_ma2 and bullish_cross, title="Bullish MA cross", message="MA #1 crossed above MA #2")
alertcondition(enable_ma1 and enable_ma2 and bearish_cross, title="Bearish MA cross", message="MA #1 crossed below MA #2")

// === Session highlighting ===

show_sessions = input.bool(false, "Highlight sessions")
session_start = input.session("1300-2000", "Session time")
session_color = input.color(color.new(color.blue, 85), "Session color")

in_session = session.ismarket(session_start)

bgcolor(show_sessions and in_session ? session_color : na)

// === Table summary ===

table_show        = input.bool(true, "Show metrics table")
table_position    = input.string("Top Right", "Table position", options=["Top Right", "Top Left", "Bottom Right", "Bottom Left"])
table_bg_color    = input.color(color.new(color.black, 10), "Table background")
table_text_color  = input.color(color.white, "Table text color")

table_position_resolve(pos) =>
    switch pos
        "Top Left" => position.top_left
        "Bottom Right" => position.bottom_right
        "Bottom Left" => position.bottom_left
        => position.top_right

var metrics_table = table.new(table_position_resolve(table_position), 2, 6, border_width=1, border_color=color.new(color.gray, 75))

if barstate.islast
    table.clear(metrics_table)
    table.cell(metrics_table, 0, 0, "Symbol", text_color=table_text_color, bgcolor=table_bg_color)
    table.cell(metrics_table, 1, 0, calc_symbol, text_color=table_text_color, bgcolor=table_bg_color)
    table.cell(metrics_table, 0, 1, "Price", text_color=table_text_color, bgcolor=table_bg_color)
    table.cell(metrics_table, 1, 1, str.tostring(price, format.mintick), text_color=table_text_color, bgcolor=table_bg_color)
    table.cell(metrics_table, 0, 2, "MA1", text_color=table_text_color, bgcolor=table_bg_color)
    table.cell(metrics_table, 1, 2, str.tostring(ma1, format.mintick), text_color=table_text_color, bgcolor=table_bg_color)
    table.cell(metrics_table, 0, 3, "MA2", text_color=table_text_color, bgcolor=table_bg_color)
    table.cell(metrics_table, 1, 3, str.tostring(ma2, format.mintick), text_color=table_text_color, bgcolor=table_bg_color)
    table.cell(metrics_table, 0, 4, "RSI", text_color=table_text_color, bgcolor=table_bg_color)
    table.cell(metrics_table, 1, 4, str.tostring(rsi_val, format.mintick), text_color=table_text_color, bgcolor=table_bg_color)
    table.cell(metrics_table, 0, 5, "Trend", text_color=table_text_color, bgcolor=table_bg_color)
    table.cell(metrics_table, 1, 5, bullish_cross ? "Bullish" : bearish_cross ? "Bearish" : "Neutral", text_color=table_text_color, bgcolor=table_bg_color)

